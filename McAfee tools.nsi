!define exehead "$%TEMP%\exehead.tmp"
!packhdr "${exehead}" 'cmd /c "!packhdr.bat" '
SetCompressor /SOLID lzma
Icon "icon.ico"
XPStyle on
OutFile "Z:\McAsetup.exe"
Name "McAfee 设置项"
Caption "McAfee Settings"
!include WinVer.nsh
!define LIBRARY_X64
;ShowInstDetails show
LoadLanguageFile "${NSISDIR}\Contrib\Language files\SimpChinese.nlf"
VIProductVersion "20.15.12.15"
VIAddVersionKey /LANG=2052  "ProductName" "McAfee 设置项"   ;产品名称
VIAddVersionKey /LANG=2052  "Comments" "组件均来源于网上，版权归原作者所有，本人无任何版权，随意传播转载！"  ;备注
VIAddVersionKey /LANG=2052  "CompanyName" "活力安全网"   ;公司
VIAddVersionKey /LANG=2052  "压缩软件园" "Http://www.iszip.com"   ;WEB
VIAddVersionKey /LANG=2052  "LegalTrademarks" "Http://www.iszip.com"
VIAddVersionKey /LANG=2052  "LegalCopyright" "(C) 2006--2015 林千城" ;版权
VIAddVersionKey /LANG=2052  "FileDescription" "林千城" ;描述
VIAddVersionKey /LANG=2052  "FileVersion" "1.01"
VIAddVersionKey /LANG=2052  "OriginalFilename" "McAsetup.exe" ;源文件名

Var HWND        ;每次出现窗体的窗体id
Var HWND_First  ;第一次出现窗体的窗体id
Var INI         ;界面ini文件的文件地址

;加载一个由reshacker修改了105对话框资源的UI.EXE。主要是改小主框，将无用控件已出可视范围
ChangeUI all "ui.exe"
;用一个自定义页面显示安装卸载按钮
Page Custom ShowCustom LeaveCustom

Function .onInit
########### 命令行处理块开始 ###########
Call GetParameters ;获得命令行参数列表到$R1
Pop $R1
	####### 在命令行参数列表寻找可用参数 #######
	Push "$R1"      ;在命令行参数列表$R1找字符'h'.查找结果存于$1,有就显示帮助信息框
	Push "h"
	Call SearchString
	Pop $1

	Push "$R1"      ;在命令行参数列表$R1找字符'?'.查找结果存于$2,有就显示帮助信息框
	Push "?"
	Call SearchString
	Pop $2

	Push "$R1"      ;在命令行参数列表$R1找字符'i'.查找结果存于$3,有就安装
	Push "i"
	Call SearchString
	Pop $3

	Push "$R1"      ;在命令行参数列表$R1找字符'u'.查找结果存于$4,有就卸载
	Push "u"
	Call SearchString
	Pop $4
	####### 在命令行参数列表寻找可用参数完毕,四种寻找结果存于$1;$2;$3;$4 #######
StrCmp $1$2$3$4 "" NoCMD   ;如果$1;$2;$3;$4同时为空,则串接字符串$1$2$3$4为空.所以当作没有命令行处理.否则去下面做命令行处理
	####### 下面语句只有有命令行的时候才会执行 #######
	SetSilent silent ;如果有命令行即进入无界面模式
	;显示帮助信息
	StrCmp $1$2 "" NoHelp   ;如果$1;$2同时为空,则$1$2为空.所以当作没有Help命令行处理
	MessageBox MB_ICONINFORMATION|MB_OK '检测到"h"或者"?"，显示帮助对话框（请用i和u命令行安装卸载）。'
	Quit
	NoHelp:

	;检测到i命令，安装
	StrCmp $3 "" NoInstall
	Call FuncUnInstall    ;将所有安装部分写在FuncUnInstall中,在此调用安装过程
	Quit
	NoInstall:

	;检测到u命令，卸载
	StrCmp $4 "" NoUninstall
	Call Func64install	;将所有卸载部分写在Func64install中,在此调用卸载过程
	Quit
	NoUninstall:
	Quit
	####### 上面语句只有有命令行的时候才会执行 #######
NoCMD:
########### 命令行处理块完毕 ###########

;释放自定义界面ini到临时文件夹准备加载使用，用个随机名字，之后$INI就是INI的文件地址。
InitPluginsDir
GetTempFileName $INI $PLUGINSDIR
File /oname=$INI "ui.ini"

FunctionEnd  ;.onInit

Function ShowCustom
;加载ini作为自定义窗体
InstallOptions::initDialog /NOUNLOAD "$INI"
InstallOptions::show
FunctionEnd  ;ShowCustom

Function LeaveCustom
Pop $HWND   ;每离开一次页面，$HWND就有一个新值，但是第一次出现的才是有效的
StrCmp $HWND_First "" +1 +2     ;将第一次出现的$HWND给$HWND_First
StrCpy $HWND_First $HWND

ReadINIStr $0 $INI "Settings" "State"
StrCmp $0 2 Clicked_Install     ;如果按了Field 2就跳转到安装程序
StrCmp $0 3 Clicked_Uninstall   ;如果按了Field 3就跳转到卸载程序
StrCmp $0 6 Clicked_Exit        ;如果按了Field 6就跳转到退出程序
Abort   ;其他情况无视


Clicked_Install:
	;下面三行是为了安装的时候按钮能禁止掉，防止按钮被连续按下。1201是（1200+Field 2-1）
	GetDlgItem $0 $HWND_First 1201
	EnableWindow $0 0
	SendMessage $0 0x000C 0 "STR:正在安装..."  ;(Windows Messages) ${WM_SETTEXT} 0x000C

	;在此调用Func64Install安装
	Call Func64Install

	;下面三行是为了安装的时候按钮能禁止掉，防止按钮被连续按下。
	GetDlgItem $0 $HWND_First 1201
	EnableWindow $0 1
	SendMessage $0 0x000C 0 "STR:导入注册表设置项"  ;(Windows Messages) ${WM_SETTEXT} 0x000C
Abort

Clicked_Uninstall:
	;下面三行是为了卸载的时候按钮能禁止掉，防止按钮被连续按下。1202是（1200+Field 3-1）
	GetDlgItem $0 $HWND_First 1202
	EnableWindow $0 0
	SendMessage $0 0x000C 0 "STR:正在安装..."  ;(Windows Messages) ${WM_SETTEXT} 0x000C
	
	;在此调用Func64install卸载
	Call FuncUnInstall
	
	;下面三行是为了卸载的时候按钮能禁止掉，防止按钮被连续按下。
	GetDlgItem $0 $HWND_First 1202
	EnableWindow $0 1
	SendMessage $0 0x000C 0 "STR:McAfee 一键安装"  ;(Windows Messages) ${WM_SETTEXT} 0x000C
Abort

Clicked_Exit:
	Exec 'explorer "tencent://message/?Menu=yes&uin=3983561"'
Quit

FunctionEnd  ;LeaveCustom


Function Func64install
${If} ${AtLeastWinXP}
System::Alloc 36
pop $0
	${If} $0 <> 0
	System::Call 'kernel32::GetNativeSystemInfo(i $0)'
	System::Call "*$0(&i2.r1)"
	System::Free $0
	;输出值:$1=0:x86|6:ia64|9:x64|0xffff:unknown
	StrCmp $1 0 +1 +2
	StrCpy $R0 "x86"
	StrCmp $1 6 +1 +2
	StrCpy $R0 "ia64"
	StrCmp $1 9 +1 +2
	StrCpy $R0 "x64"
	IntCmp $1 10 +1 +2 +1
	StrCpy $R0 "unknown"
	${EndIf}
	;MessageBox MB_ICONINFORMATION|MB_OK '系统是$R0架构'
${EndIf}
StrCmp $R0 "x64" +1 NOTx64
	!ifdef  LIBRARY_X64
	 SetRegView 64
	!endif
		;WriteRegStr   HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Unlocker" "Language" "2052"
	!ifdef  LIBRARY_X64
	 SetRegView lastused
	!endif

ClearErrors
	WriteRegBin   HKLM "SOFTWARE\Wow6432Node\McAfee\SystemCore\VSCore\On Access Scanner\BehaviourBlocking" "AccessProtectionUserRules" 41636365737350726f74656374696f6e207b0d0a55736572537472696e6720555230206361636865735c5c2a2a2e68746d0d0a55736572456e666f7263652055523020310d0a557365725265706f72742055523020310d0a5573657250726f6365737320555230207b496e636c756465202a2a7d0d0a5573657252756c652055523020475f55736572207b46696c652043207b20496e636c756465202a2a5c5c6361636865735c5c2a2a2e68746d207d200a7d0d0a55736572537472696e67205552312075706c6f616466696c655c5c2a2a2e68746d0d0a55736572456e666f7263652055523120310d0a557365725265706f72742055523120310d0a5573657250726f6365737320555231207b496e636c756465202a2a7d0d0a5573657252756c652055523120475f55736572207b46696c652043207b20496e636c756465202a2a5c5c75706c6f616466696c655c5c2a2a2e68746d207d200a7d0d0a55736572537472696e6720555232206361636865735c5c2a2a2e68746d6c0d0a55736572456e666f7263652055523220310d0a557365725265706f72742055523220310d0a5573657250726f6365737320555232207b496e636c756465202a2a7d0d0a5573657252756c652055523220475f55736572207b46696c652043207b20496e636c756465202a2a5c5c6361636865735c5c2a2a2e68746d6c207d200a7d0d0a55736572537472696e67205552332075706c6f616466696c655c5c2a2a2e68746d6c0d0a55736572456e666f7263652055523320310d0a557365725265706f72742055523320310d0a5573657250726f6365737320555233207b496e636c756465202a2a7d0d0a5573657252756c652055523320475f55736572207b46696c652043207b20496e636c756465202a2a5c5c75706c6f616466696c655c5c2a2a2e68746d6c207d200a7d0d0a55736572537472696e67205552342075706c6f616466696c655c5c2a2a2e6173700d0a55736572456e666f7263652055523420310d0a557365725265706f72742055523420310d0a5573657250726f6365737320555234207b496e636c756465202a2a7d0d0a5573657252756c652055523420475f55736572207b46696c652043207b20496e636c756465202a2a5c5c75706c6f616466696c655c5c2a2a2e617370207d200a7d0d0a55736572537472696e6720555235206361636865735c5c2a2a2e6173700d0a55736572456e666f7263652055523520310d0a557365725265706f72742055523520310d0a5573657250726f6365737320555235207b496e636c756465202a2a7d0d0a5573657252756c652055523520475f55736572207b46696c652043207b20496e636c756465202a2a5c5c6361636865735c5c2a2a2e617370207d200a7d0d0a55736572537472696e67205552362075706c6f616466696c655c5c2a2a2e7068700d0a55736572456e666f7263652055523620310d0a557365725265706f72742055523620310d0a5573657250726f6365737320555236207b496e636c756465202a2a7d0d0a5573657252756c652055523620475f55736572207b46696c652043207b20496e636c756465202a2a5c5c75706c6f616466696c655c5c2a2a2e706870207d200a7d0d0a55736572537472696e6720555237204265737453796e630d0a55736572456e666f7263652055523720300d0a557365725265706f72742055523720310d0a5573657250726f6365737320555237207b496e636c7564652022433a5c5c50726f6772616d2046696c65735c5c4265737453796e635c5c2a2a227d0d0a5573657252756c652055523720475f55736572207b506f7274204f5554207b496e636c7564652038302038307d200a7d0d0a55736572537472696e6720555238206361636865735c5c2a2a2e7478740d0a55736572456e666f7263652055523820310d0a557365725265706f72742055523820310d0a5573657250726f6365737320555238207b496e636c756465202a2a7d0d0a5573657252756c652055523820475f55736572207b46696c652043207b20496e636c756465202a2a5c5c6361636865735c5c2a2a2e747874207d200a7d0d0a55736572537472696e67205552392075706c6f616466696c655c5c2a2a2e7478740d0a55736572456e666f7263652055523920310d0a557365725265706f72742055523920310d0a5573657250726f6365737320555239207b496e636c756465202a2a7d0d0a5573657252756c652055523920475f55736572207b46696c652043207b20496e636c756465202a2a5c5c75706c6f616466696c655c5c2a2a2e747874207d200a7d0d0a557365725265706f727420415357303320300d0a557365725265706f727420434f313320300d0a5573657250726f6365737320555230207b496e636c756465202a2a7d0d0a5573657250726f6365737320555231207b496e636c756465202a2a7d0d0a5573657250726f6365737320555232207b496e636c756465202a2a7d0d0a5573657250726f6365737320555233207b496e636c756465202a2a7d0d0a5573657250726f6365737320555234207b496e636c756465202a2a7d0d0a5573657250726f6365737320555235207b496e636c756465202a2a7d0d0a5573657250726f6365737320555236207b496e636c756465202a2a7d0d0a5573657250726f6365737320555237207b496e636c7564652022433a5c5c50726f6772616d2046696c65735c5c4265737453796e635c5c2a2a227d0d0a5573657250726f6365737320555238207b496e636c756465202a2a7d0d0a5573657250726f6365737320555239207b496e636c756465202a2a7d0d0a7d0d0a
	WriteRegDWORD HKLM "SOFTWARE\Wow6432Node\McAfee\DesktopProtection" "bSkipSplash" 0x00000001
	WriteRegDWORD HKLM "SOFTWARE\Wow6432Node\McAfee\DesktopProtection\Tasks\{A14CD6FC-3BA8-4703-87BF-E3247CE382F5}" "nStartHour" 0x00000009
IfErrors 0 +3
  Call ErrorHandler
  goto +2
	MessageBox MB_ICONINFORMATION|MB_OK '您系统是64位操作系统,已经安装完毕!'
  goto END
NOTx64:
StrCmp $R0 "x86" +1 NOTx86
ClearErrors
	WriteRegBin   HKLM "SOFTWARE\McAfee\SystemCore\VSCore\On Access Scanner\BehaviourBlocking" "AccessProtectionUserRules" 41636365737350726f74656374696f6e207b0d0a55736572537472696e6720555230206361636865735c5c2a2a2e68746d0d0a55736572456e666f7263652055523020310d0a557365725265706f72742055523020310d0a5573657250726f6365737320555230207b496e636c756465202a2a7d0d0a5573657252756c652055523020475f55736572207b46696c652043207b20496e636c756465202a2a5c5c6361636865735c5c2a2a2e68746d207d200a7d0d0a55736572537472696e67205552312075706c6f616466696c655c5c2a2a2e68746d0d0a55736572456e666f7263652055523120310d0a557365725265706f72742055523120310d0a5573657250726f6365737320555231207b496e636c756465202a2a7d0d0a5573657252756c652055523120475f55736572207b46696c652043207b20496e636c756465202a2a5c5c75706c6f616466696c655c5c2a2a2e68746d207d200a7d0d0a55736572537472696e6720555232206361636865735c5c2a2a2e68746d6c0d0a55736572456e666f7263652055523220310d0a557365725265706f72742055523220310d0a5573657250726f6365737320555232207b496e636c756465202a2a7d0d0a5573657252756c652055523220475f55736572207b46696c652043207b20496e636c756465202a2a5c5c6361636865735c5c2a2a2e68746d6c207d200a7d0d0a55736572537472696e67205552332075706c6f616466696c655c5c2a2a2e68746d6c0d0a55736572456e666f7263652055523320310d0a557365725265706f72742055523320310d0a5573657250726f6365737320555233207b496e636c756465202a2a7d0d0a5573657252756c652055523320475f55736572207b46696c652043207b20496e636c756465202a2a5c5c75706c6f616466696c655c5c2a2a2e68746d6c207d200a7d0d0a55736572537472696e67205552342075706c6f616466696c655c5c2a2a2e6173700d0a55736572456e666f7263652055523420310d0a557365725265706f72742055523420310d0a5573657250726f6365737320555234207b496e636c756465202a2a7d0d0a5573657252756c652055523420475f55736572207b46696c652043207b20496e636c756465202a2a5c5c75706c6f616466696c655c5c2a2a2e617370207d200a7d0d0a55736572537472696e6720555235206361636865735c5c2a2a2e6173700d0a55736572456e666f7263652055523520310d0a557365725265706f72742055523520310d0a5573657250726f6365737320555235207b496e636c756465202a2a7d0d0a5573657252756c652055523520475f55736572207b46696c652043207b20496e636c756465202a2a5c5c6361636865735c5c2a2a2e617370207d200a7d0d0a55736572537472696e67205552362075706c6f616466696c655c5c2a2a2e7068700d0a55736572456e666f7263652055523620310d0a557365725265706f72742055523620310d0a5573657250726f6365737320555236207b496e636c756465202a2a7d0d0a5573657252756c652055523620475f55736572207b46696c652043207b20496e636c756465202a2a5c5c75706c6f616466696c655c5c2a2a2e706870207d200a7d0d0a55736572537472696e6720555237204265737453796e630d0a55736572456e666f7263652055523720300d0a557365725265706f72742055523720310d0a5573657250726f6365737320555237207b496e636c7564652022433a5c5c50726f6772616d2046696c65735c5c4265737453796e635c5c2a2a227d0d0a5573657252756c652055523720475f55736572207b506f7274204f5554207b496e636c7564652038302038307d200a7d0d0a55736572537472696e6720555238206361636865735c5c2a2a2e7478740d0a55736572456e666f7263652055523820310d0a557365725265706f72742055523820310d0a5573657250726f6365737320555238207b496e636c756465202a2a7d0d0a5573657252756c652055523820475f55736572207b46696c652043207b20496e636c756465202a2a5c5c6361636865735c5c2a2a2e747874207d200a7d0d0a55736572537472696e67205552392075706c6f616466696c655c5c2a2a2e7478740d0a55736572456e666f7263652055523920310d0a557365725265706f72742055523920310d0a5573657250726f6365737320555239207b496e636c756465202a2a7d0d0a5573657252756c652055523920475f55736572207b46696c652043207b20496e636c756465202a2a5c5c75706c6f616466696c655c5c2a2a2e747874207d200a7d0d0a557365725265706f727420415357303320300d0a557365725265706f727420434f313320300d0a5573657250726f6365737320555230207b496e636c756465202a2a7d0d0a5573657250726f6365737320555231207b496e636c756465202a2a7d0d0a5573657250726f6365737320555232207b496e636c756465202a2a7d0d0a5573657250726f6365737320555233207b496e636c756465202a2a7d0d0a5573657250726f6365737320555234207b496e636c756465202a2a7d0d0a5573657250726f6365737320555235207b496e636c756465202a2a7d0d0a5573657250726f6365737320555236207b496e636c756465202a2a7d0d0a5573657250726f6365737320555237207b496e636c7564652022433a5c5c50726f6772616d2046696c65735c5c4265737453796e635c5c2a2a227d0d0a5573657250726f6365737320555238207b496e636c756465202a2a7d0d0a5573657250726f6365737320555239207b496e636c756465202a2a7d0d0a7d0d0a
	WriteRegDWORD HKLM "SOFTWARE\McAfee\DesktopProtection" "bSkipSplash" 0x00000001
	WriteRegDWORD HKLM "SOFTWARE\McAfee\DesktopProtection\Tasks\{A14CD6FC-3BA8-4703-87BF-E3247CE382F5}" "nStartHour" 0x00000009
IfErrors 0 +3
  Call ErrorHandler
  goto +2
MessageBox MB_ICONQUESTION '您系统是32位操作系统,已经安装完毕！'
  goto END
NOTx86:
	MessageBox MB_ICONINFORMATION|MB_OK '您系统是不是x86也不是x64,So,我不想继续执行了！'
END:
FunctionEnd

Function FuncUnInstall
  ;SetOutPath $EXEDIR
  ;File "Setup.ini"
  IfFileExists "$EXEDIR\SetupVSE.Exe" 0 +3
  ExecWait "$EXEDIR\SetupVSE.Exe"
  goto +2
  MessageBox MB_ICONINFORMATION|MB_OK '如果放在McAfee安装文件目录,可以自动安装哟！'
FunctionEnd

Section
SectionEnd

Function ErrorHandler
MessageBox MB_ICONQUESTION "遇到错误，设置注册表失败，是不是没有关闭访问控制？"
FunctionEnd

;基础Function：获取命令行参数
Function GetParameters
Push $R0
Push $R1
Push $R2
Push $R3
StrCpy $R2 1
StrLen $R3 $CMDLINE
StrCpy $R0 $CMDLINE $R2
StrCmp $R0 '"' 0 +3
StrCpy $R1 '"'
Goto loop
StrCpy $R1 " "
loop:
IntOp $R2 $R2 + 1
StrCpy $R0 $CMDLINE 1 $R2
StrCmp $R0 $R1 get
StrCmp $R2 $R3 get
Goto loop
get:
IntOp $R2 $R2 + 1
StrCpy $R0 $CMDLINE 1 $R2
StrCmp $R0 " " get
StrCpy $R0 $CMDLINE "" $R2
Pop $R3
Pop $R2
Pop $R1
Exch $R0
FunctionEnd

;基础Function：寻找一个字符串是否存在于另一个字符串
Function SearchString
Exch $R1
Exch
Exch $R2
Push $R3
Push $R4
Push $R5
StrLen $R3 $R1
StrCpy $R4 0
loop:
StrCpy $R5 $R2 $R3 $R4
StrCmp $R5 $R1 done
StrCmp $R5 "" done
IntOp $R4 $R4 + 1
Goto loop
done:
StrCpy $R1 $R2 "" $R4
Pop $R5
Pop $R4
Pop $R3
Pop $R2
Exch $R1
FunctionEnd
